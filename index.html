<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Linguistico Interattivo</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tutor Linguistico">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Loading animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <div>
            <div class="spinner"></div>
            <p class="mt-4 text-gray-600">Caricamento Tutor Linguistico...</p>
        </div>
    </div>
    
    <!-- App container -->
    <div id="root" style="display: none;"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Send, MessageCircle, Target, TrendingUp, Star, Award, CheckCircle, AlertCircle } = lucide;

        const LanguageTutor = () => {
          const [selectedLanguage, setSelectedLanguage] = useState('spanish');
          const [currentMessage, setCurrentMessage] = useState('');
          const [messages, setMessages] = useState([]);
          const [isLoading, setIsLoading] = useState(false);
          const [userLevel, setUserLevel] = useState('beginner');
          const [mode, setMode] = useState('casual');
          const [sessionStats, setSessionStats] = useState({
            messagesCount: 0,
            vocabUsed: new Set(),
            errorsFound: 0,
            sessionDuration: 0
          });
          const [learningGoals, setLearningGoals] = useState([]);
          const [feedback, setFeedback] = useState([]);
          const [progress, setProgress] = useState({
            vocabulary: 65,
            grammar: 45,
            conversation: 70
          });
          
          const messagesEndRef = useRef(null);
          const sessionStartTime = useRef(Date.now());

          const languages = {
            spanish: { name: 'Español', flag: '🇪🇸', greeting: '¡Hola! Soy tu tutor de español. ¿De qué te gustaría hablar hoy?' },
            french: { name: 'Français', flag: '🇫🇷', greeting: 'Bonjour! Je suis votre tuteur de français. De quoi aimeriez-vous parler aujourd\'hui?' },
            german: { name: 'Deutsch', flag: '🇩🇪', greeting: 'Hallo! Ich bin Ihr Deutsch-Tutor. Worüber möchten Sie heute sprechen?' },
            japanese: { name: '日本語', flag: '🇯🇵', greeting: 'こんにちは！日本語のチューターです。今日は何について話したいですか？' },
            english: { name: 'English', flag: '🇺🇸', greeting: 'Hello! I\'m your English tutor. What would you like to talk about today?' },
            italian: { name: 'Italiano', flag: '🇮🇹', greeting: 'Ciao! Sono il tuo tutor di italiano. Di cosa vorresti parlare oggi?' },
            portuguese: { name: 'Português', flag: '🇧🇷', greeting: 'Olá! Sou seu tutor de português. Do que gostaria de falar hoje?' }
          };

          const levelColors = {
            beginner: 'bg-green-100 text-green-800',
            intermediate: 'bg-yellow-100 text-yellow-800',
            advanced: 'bg-red-100 text-red-800'
          };

          useEffect(() => {
            initializeGoals();
            addWelcomeMessage();
            // Hide loading screen
            setTimeout(() => {
              document.getElementById('loading').style.display = 'none';
              document.getElementById('root').style.display = 'block';
            }, 1000);
          }, [selectedLanguage]);

          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          useEffect(() => {
            const interval = setInterval(() => {
              setSessionStats(prev => ({
                ...prev,
                sessionDuration: Math.floor((Date.now() - sessionStartTime.current) / 1000)
              }));
            }, 1000);
            return () => clearInterval(interval);
          }, []);

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          };

          const initializeGoals = () => {
            const defaultGoals = {
              spanish: [
                'Padroneggiare la coniugazione dei verbi irregolari',
                'Espandere il vocabolario relativo al cibo',
                'Migliorare l\'uso di ser vs estar',
                'Praticare le forme di cortesia'
              ],
              french: [
                'Migliorare la pronuncia delle vocali',
                'Padroneggiare gli accordi degli aggettivi',
                'Espandere il vocabolario familiare',
                'Praticare i tempi del passato'
              ],
              german: [
                'Memorizzare gli articoli determinativi',
                'Praticare l\'ordine delle parole',
                'Espandere il vocabolario professionale',
                'Migliorare la declinazione degli aggettivi'
              ],
              japanese: [
                'Memorizzare i kanji di base',
                'Praticare le forme di cortesia',
                'Migliorare la pronuncia',
                'Espandere il vocabolario quotidiano'
              ],
              english: [
                'Migliorare la pronuncia',
                'Espandere il vocabolario accademico',
                'Praticare i phrasal verbs',
                'Perfezionare i tempi verbali'
              ],
              italian: [
                'Padroneggiare i tempi del passato',
                'Migliorare l\'uso delle preposizioni',
                'Espandere il vocabolario culinario',
                'Praticare il congiuntivo'
              ],
              portuguese: [
                'Distinguere ser vs estar',
                'Migliorare la pronuncia nasale',
                'Espandere il vocabolario brasiliano',
                'Praticare i tempi del futuro'
              ]
            };
            setLearningGoals(defaultGoals[selectedLanguage] || []);
          };

          const addWelcomeMessage = () => {
            const welcomeMessage = {
              id: Date.now(),
              type: 'tutor',
              text: languages[selectedLanguage].greeting,
              timestamp: new Date()
            };
            setMessages([welcomeMessage]);
          };

          const analyzeMessage = (text) => {
            const analysis = {
              feedback: [],
              errors: [],
              vocabulary: [],
              level: userLevel
            };

            const words = text.toLowerCase().split(/\s+/);
            analysis.vocabulary = words.filter(word => word.length > 3);

            if (selectedLanguage === 'spanish') {
              if (text.includes('para') || text.includes('por')) {
                analysis.feedback.push('Ottimo uso delle preposizioni spagnole!');
              }
              if (text.match(/\b(soy|es|está|estoy|son|están)\b/)) {
                analysis.feedback.push('Bene! Stai usando correttamente i verbi ser/estar.');
              }
              if (text.match(/\b(muy|mucho|muchos|muchas)\b/)) {
                analysis.feedback.push('Perfetto! Uso corretto degli intensificatori.');
              }
              if (text.match(/\b(me gusta|te gusta|le gusta)\b/)) {
                analysis.feedback.push('Eccellente uso del verbo "gustar"!');
              }
              if (text.length > 10 && !text.match(/[¿¡]/)) {
                analysis.errors.push('Ricorda: usa ¿ e ¡ nelle domande ed esclamazioni');
              }
            } else if (selectedLanguage === 'french') {
              if (text.includes('je suis') || text.includes('tu es') || text.includes('il est')) {
                analysis.feedback.push('Excellente conjugaison du verbe être!');
              }
              if (text.match(/\b(le|la|les|un|une|des)\b/)) {
                analysis.feedback.push('Bon usage des articles!');
              }
              if (text.match(/\b(très|beaucoup|bien|assez)\b/)) {
                analysis.feedback.push('Très bien! Bonne utilisation des adverbes.');
              }
              if (text.match(/\b(j'aime|tu aimes|il aime)\b/)) {
                analysis.feedback.push('Parfait! Bon usage du verbe "aimer".');
              }
            } else if (selectedLanguage === 'english') {
              if (text.match(/\b(am|is|are|was|were)\b/)) {
                analysis.feedback.push('Good use of the verb "to be"!');
              }
              if (text.match(/\b(very|really|quite|extremely)\b/)) {
                analysis.feedback.push('Nice use of adverbs for emphasis!');
              }
              if (text.match(/\b(I like|you like|he likes|she likes)\b/)) {
                analysis.feedback.push('Great use of the verb "to like"!');
              }
              if (text.match(/\b(the|a|an)\b/)) {
                analysis.feedback.push('Correct use of articles!');
              }
            } else if (selectedLanguage === 'german') {
              if (text.match(/\b(ich bin|du bist|er ist|sie ist)\b/)) {
                analysis.feedback.push('Ausgezeichnet! Perfekte Konjugation von "sein".');
              }
              if (text.match(/\b(der|die|das|ein|eine)\b/)) {
                analysis.feedback.push('Gut! Korrekte Verwendung der Artikel.');
              }
              if (text.match(/\b(sehr|wirklich|ziemlich)\b/)) {
                analysis.feedback.push('Sehr gut! Richtige Verwendung von Adverbien.');
              }
            } else if (selectedLanguage === 'italian') {
              if (text.match(/\b(sono|sei|è|siamo|siete|sono)\b/)) {
                analysis.feedback.push('Perfetto! Coniugazione corretta del verbo "essere".');
              }
              if (text.match(/\b(il|la|lo|gli|le|un|una)\b/)) {
                analysis.feedback.push('Ottimo uso degli articoli!');
              }
              if (text.match(/\b(molto|abbastanza|davvero)\b/)) {
                analysis.feedback.push('Bene! Uso corretto degli avverbi.');
              }
            } else if (selectedLanguage === 'portuguese') {
              if (text.match(/\b(sou|é|está|estou|são|estão)\b/)) {
                analysis.feedback.push('Ótimo! Uso correto dos verbos ser/estar.');
              }
              if (text.match(/\b(o|a|os|as|um|uma)\b/)) {
                analysis.feedback.push('Perfeito uso dos artigos!');
              }
              if (text.match(/\b(muito|bastante|realmente)\b/)) {
                analysis.feedback.push('Excelente! Bom uso dos advérbios.');
              }
            } else if (selectedLanguage === 'japanese') {
              if (text.match(/です|だ|である/)) {
                analysis.feedback.push('素晴らしい！正しい丁寧語の使用です。');
              }
              if (text.match(/は|が|を|に|で|と/)) {
                analysis.feedback.push('いいですね！助詞の使い方が正しいです。');
              }
              if (text.match(/ます|ました|ません|ませんでした/)) {
                analysis.feedback.push('完璧！動詞の活用が正確です。');
              }
            }

            // Level assessment
            if (words.length > 20 && analysis.vocabulary.length > 10) {
              analysis.level = 'advanced';
            } else if (words.length > 10 && analysis.vocabulary.length > 5) {
              analysis.level = 'intermediate';
            }

            return analysis;
          };

          const generateTutorResponse = async (userMessage) => {
            const responses = {
              spanish: [
                '¡Muy bien! Me gusta cómo te expresas. ¿Puedes contarme más sobre eso?',
                'Interesante. En español también podríamos decir... ¿Conoces otras formas de expresar esto?',
                '¡Excelente! Tu español está mejorando mucho. ¿Qué otros temas te interesan?',
                'Perfecto uso del vocabulario. ¿Te gusta practicar conversaciones así?',
                '¡Muy natural! ¿Podrías usar esa estructura en otra frase?',
                'Me encanta tu progreso. ¿Hay algo específico que te gustaría practicar?'
              ],
              french: [
                'C\'est très bien! J\'aime votre façon de vous exprimer. Pouvez-vous m\'en dire plus?',
                'Intéressant. En français, nous pourrions aussi dire... Connaissez-vous d\'autres façons?',
                'Excellent! Votre français s\'améliore beaucoup. Quels autres sujets vous intéressent?',
                'Parfait! Votre grammaire est très correcte. Continuez comme ça!',
                'Très naturel! Pourriez-vous utiliser cette structure dans une autre phrase?',
                'J\'adore vos progrès. Y a-t-il quelque chose de spécifique que vous aimeriez pratiquer?'
              ],
              german: [
                'Das ist sehr gut! Mir gefällt, wie Sie sich ausdrücken. Können Sie mir mehr erzählen?',
                'Interessant. Auf Deutsch könnten wir auch sagen... Kennen Sie andere Arten?',
                'Ausgezeichnet! Ihr Deutsch wird viel besser. Welche anderen Themen interessieren Sie?',
                'Perfekt! Ihre Grammatik ist sehr korrekt. Machen Sie weiter so!',
                'Sehr natürlich! Könnten Sie diese Struktur in einem anderen Satz verwenden?',
                'Ich liebe Ihre Fortschritte. Gibt es etwas Bestimmtes, das Sie üben möchten?'
              ],
              japanese: [
                'とても良いですね！あなたの表現方法が好きです。もっと教えてくれませんか？',
                '面白いですね。日本語では他の言い方もあります...他の方法を知っていますか？',
                '素晴らしい！あなたの日本語がとても上達しています。他にどんな話題に興味がありますか？',
                '完璧です！文法がとても正しいです。そのまま続けてください！',
                'とても自然です！この構造を他の文でも使えますか？',
                'あなたの進歩が大好きです。特に練習したいことはありますか？'
              ],
              english: [
                'That\'s very good! I like how you express yourself. Can you tell me more about that?',
                'Interesting. In English we could also say... Do you know other ways to express this?',
                'Excellent! Your English is improving a lot. What other topics interest you?',
                'Perfect! Your grammar is very correct. Keep it up!',
                'Very natural! Could you use that structure in another sentence?',
                'I love your progress. Is there something specific you\'d like to practice?'
              ],
              italian: [
                'Molto bene! Mi piace come ti esprimi. Puoi dirmi di più?',
                'Interessante. In italiano potremmo anche dire... Conosci altri modi?',
                'Eccellente! Il tuo italiano sta migliorando molto. Che altri argomenti ti interessano?',
                'Perfetto! La tua grammatica è molto corretta. Continua così!',
                'Molto naturale! Potresti usare quella struttura in un\'altra frase?',
                'Adoro i tuoi progressi. C\'è qualcosa di specifico che vorresti praticare?'
              ],
              portuguese: [
                'Muito bom! Gosto de como você se expressa. Pode me falar mais sobre isso?',
                'Interessante. Em português também poderíamos dizer... Você conhece outras formas?',
                'Excelente! Seu português está melhorando muito. Que outros assuntos te interessam?',
                'Perfeito! Sua gramática está muito correta. Continue assim!',
                'Muito natural! Você poderia usar essa estrutura em outra frase?',
                'Adoro seu progresso. Há algo específico que gostaria de praticar?'
              ]
            };

            const langResponses = responses[selectedLanguage] || responses.english;
            return langResponses[Math.floor(Math.random() * langResponses.length)];
          };

          const handleSendMessage = async () => {
            if (!currentMessage.trim()) return;

            const userMessage = {
              id: Date.now(),
              type: 'user',
              text: currentMessage,
              timestamp: new Date()
            };

            setMessages(prev => [...prev, userMessage]);
            const msgToAnalyze = currentMessage;
            setCurrentMessage('');
            setIsLoading(true);

            const analysis = analyzeMessage(msgToAnalyze);
            
            setSessionStats(prev => ({
              messagesCount: prev.messagesCount + 1,
              vocabUsed: new Set([...prev.vocabUsed, ...analysis.vocabulary]),
              errorsFound: prev.errorsFound + analysis.errors.length,
              sessionDuration: prev.sessionDuration
            }));

            if (analysis.feedback.length > 0 || analysis.errors.length > 0) {
              setFeedback(prev => [...prev.slice(-4), {
                id: Date.now(),
                message: msgToAnalyze,
                feedback: analysis.feedback,
                errors: analysis.errors,
                timestamp: new Date()
              }]);
            }

            if (analysis.level !== userLevel) {
              setUserLevel(analysis.level);
            }

            try {
              const tutorResponse = await generateTutorResponse(msgToAnalyze);
              
              setTimeout(() => {
                const tutorMessage = {
                  id: Date.now() + 1,
                  type: 'tutor',
                  text: tutorResponse,
                  timestamp: new Date()
                };
                setMessages(prev => [...prev, tutorMessage]);
                setIsLoading(false);
              }, 1000 + Math.random() * 1000);
            } catch (error) {
              console.error('Error generating response:', error);
              setIsLoading(false);
            }
          };

          const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          };

          const addCustomGoal = () => {
            const goal = prompt('Inserisci un nuovo obiettivo di apprendimento:');
            if (goal && goal.trim()) {
              setLearningGoals(prev => [...prev, goal.trim()]);
            }
          };

          const removeGoal = (index) => {
            setLearningGoals(prev => prev.filter((_, i) => i !== index));
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 overflow-x-hidden">
              <div className="container mx-auto p-2 sm:p-4 max-w-7xl">
                {/* Header */}
                <div className="bg-white rounded-xl shadow-lg p-3 sm:p-6 mb-4 sm:mb-6">
                  <div className="flex flex-col gap-3 sm:gap-4">
                    <div className="flex items-center gap-3 sm:gap-4">
                      <div className="text-2xl sm:text-3xl">{languages[selectedLanguage].flag}</div>
                      <div className="flex-1 min-w-0">
                        <h1 className="text-lg sm:text-2xl font-bold text-gray-800 truncate">Tutor Linguistico Interattivo</h1>
                        <p className="text-sm sm:text-base text-gray-600 truncate">Migliora le tue competenze in {languages[selectedLanguage].name}</p>
                      </div>
                    </div>
                    
                    <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                      <select 
                        value={selectedLanguage}
                        onChange={(e) => setSelectedLanguage(e.target.value)}
                        className="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        {Object.entries(languages).map(([code, lang]) => (
                          <option key={code} value={code}>
                            {lang.flag} {lang.name}
                          </option>
                        ))}
                      </select>
                      
                      <div className="flex items-center justify-between sm:justify-start gap-2 sm:gap-4">
                        <div className="flex items-center gap-2">
                          <span className="text-xs sm:text-sm text-gray-500">Livello:</span>
                          <span className={`px-2 py-1 rounded-full text-xs font-semibold ${levelColors[userLevel]}`}>
                            {userLevel.charAt(0).toUpperCase() + userLevel.slice(1)}
                          </span>
                        </div>
                        
                        <button
                          onClick={() => setMode(mode === 'casual' ? 'structured' : 'casual')}
                          className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${
                            mode === 'casual' 
                              ? 'bg-blue-100 text-blue-700' 
                              : 'bg-purple-100 text-purple-700'
                          }`}
                        >
                          {mode === 'casual' ? 'Chat Informale' : 'Lezione Strutturata'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-4 gap-3 sm:gap-6">
                  {/* Chat Area */}
                  <div className="lg:col-span-2 order-1">
                    <div className="bg-white rounded-xl shadow-lg h-[500px] sm:h-[600px] flex flex-col">
                      <div className="p-3 sm:p-4 border-b border-gray-200">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <MessageCircle className="w-4 h-4 sm:w-5 sm:h-5 text-blue-500" />
                            <span className="text-sm sm:text-base font-semibold text-gray-800">Conversazione</span>
                          </div>
                          <div className="text-xs sm:text-sm text-gray-500">
                            Sessione: {formatTime(sessionStats.sessionDuration)}
                          </div>
                        </div>
                      </div>

                      <div className="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4">
                        {messages.map((message) => (
                          <div
                            key={message.id}
                            className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                          >
                            <div
                              className={`max-w-[85%] sm:max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${
                                message.type === 'user'
                                  ? 'bg-blue-500 text-white'
                                  : 'bg-gray-100 text-gray-800'
                              }`}
                            >
                              <p className="text-sm sm:text-base">{message.text}</p>
                              <p className="text-xs opacity-75 mt-1">
                                {message.timestamp.toLocaleTimeString()}
                              </p>
                            </div>
                          </div>
                        ))}
                        {isLoading && (
                          <div className="flex justify-start">
                            <div className="bg-gray-100 rounded-lg px-3 py-2">
                              <div className="flex space-x-1">
                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                              </div>
                            </div>
                          </div>
                        )}
                        <div ref={messagesEndRef} />
                      </div>

                      <div className="p-3 sm:p-4 border-t border-gray-200">
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={currentMessage}
                            onChange={(e) => setCurrentMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                            placeholder={`Scrivi in ${languages[selectedLanguage].name}...`}
                            className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            disabled={isLoading}
                          />
                          <button
                            onClick={handleSendMessage}
                            disabled={isLoading || !currentMessage.trim()}
                            className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                          >
                            <Send className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Feedback Panel */}
                  <div className="lg:col-span-1 order-3 lg:order-2">
                    <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 h-[400px] sm:h-[600px] overflow-y-auto">
                      <div className="flex items-center gap-2 mb-3 sm:mb-4">
                        <AlertCircle className="w-4 h-4 sm:w-5 sm:h-5 text-orange-500" />
                        <h3 className="text-sm sm:text-base font-semibold text-gray-800">Feedback in Tempo Reale</h3>
                      </div>
                      
                      <div className="space-y-4">
                        {feedback.length === 0 ? (
